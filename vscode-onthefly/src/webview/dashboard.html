<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>On The Fly</title>
  <style>
    /* =========================================================
      On the Fly — VS Code–native themed, responsive dashboard
      NOTE: All original IDs & button labels preserved.
      ========================================================= */

    /* ---------- VS Code color tokens ---------- */
    :root {
      /* Core */
      --bg: var(--vscode-editor-background);
      --fg: var(--vscode-foreground);
      --muted: var(--vscode-descriptionForeground);
      --panel-bg: var(--vscode-editorWidget-background);
      --panel-elev: var(--vscode-editor-background);
      --border: var(--vscode-panel-border, var(--vscode-widget-border, rgba(0,0,0,.2)));

      /* Buttons */
      --btn-bg: var(--vscode-button-background);
      --btn-fg: var(--vscode-button-foreground);
      --btn-bg-hover: var(--vscode-button-hoverBackground);
      --btn-bg-secondary: var(--vscode-button-secondaryBackground, var(--vscode-dropdown-background, var(--panel-bg)));
      --btn-fg-secondary: var(--vscode-button-secondaryForeground, var(--fg));

      /* Inputs / focus */
      --input-bg: var(--vscode-input-background);
      --input-fg: var(--vscode-input-foreground);
      --input-border: var(--vscode-input-border, var(--border));
      --focus: #fff;

      /* Badges */
      --badge-bg: var(--vscode-badge-background, var(--btn-bg));
      --badge-fg: var(--vscode-badge-foreground, var(--btn-fg));

      /* Charts */
      --chart-text: var(--fg);
      --chart-grid: var(--vscode-editorWidget-border, var(--border));

      /* Neutralize heavy effects */
      --ring: 0 0 0 1px var(--border) inset;
      --btn-shadow: none;
      --btn-shadow-hover: none;

      --ease: cubic-bezier(.2,.8,.2,1);
    }

    /* ---------- Base & layout ---------- */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial, sans-serif;
      margin: 0; color: var(--fg); background: var(--bg);
      background-image: none;
      min-height: 100%;
    }

    .flyHeader {
      position: static; top: auto; z-index: auto;
      background: var(--panel-bg);
      border-bottom: 1px solid var(--border);
      backdrop-filter: none;
    }
    .flyHeaderInner { display:flex; align-items:center; gap:12px; }
    .brandMark { display:none; }
    .brandTitle { font-weight: 700; letter-spacing: .2px; font-size: 16px; }
    .brandSub { margin-left: 0; }

    .rootWrap { max-width: 1200px; margin: 16px auto; padding: 0 16px 32px; }

    /* ---------- Unified components ---------- */
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }

    button {
      padding: 8px 10px; border: 1px solid transparent; border-radius: 6px;
      background: var(--btn-bg); color: var(--btn-fg);
      cursor: pointer; box-shadow: none;
      transition: background-color .15s var(--ease), border-color .15s var(--ease), transform .06s ease;
    }
    /* Primary buttons: gentle grow on hover, crunch on click */
    button:hover:not(:disabled) {
      transform: translateY(-1px) scale(1.02);
      box-shadow: var(--btn-shadow-hover);
      filter: brightness(1.02);
    }
    button:active:not(:disabled) {
      transform: translateY(0) scale(0.98);
      filter: brightness(.98);
    }

    button:disabled { opacity: .5; cursor: not-allowed; }

    .iconBtn, .icon-btn {
      --size: 32px;
      inline-size: var(--size); block-size: var(--size);
      display: inline-flex; align-items: center; justify-content: center;
      padding: 0; border-radius: 6px;
      background: var(--btn-bg); color: var(--btn-fg);
      border: 1px solid transparent; box-shadow: none;
      transition: background-color .15s var(--ease);
    }
    /* Icon buttons: a bit more pop */
    .iconBtn:hover:not(:disabled),
    .icon-btn:hover:not(:disabled) {
      transform: translateY(-1px) scale(1.04);
      box-shadow: var(--btn-shadow-hover);
    }
    .iconBtn:active:not(:disabled),
    .icon-btn:active:not(:disabled) {
      transform: translateY(0) scale(0.96);
    }
    .iconBtn:disabled,
    .icon-btn:disabled { opacity: .4; }

    .icon { width: 18px; height: 18px; display: block; }

    label { color: var(--muted); font-weight: 600; display: inline-flex; align-items: center; gap: 6px; }

    select, input, textarea {
      padding: 6px 8px; background: var(--input-bg);
      color: var(--input-fg); border: 1px solid var(--input-border);
      border-radius: 6px; outline: none; transition: box-shadow .15s var(--ease), border-color .15s var(--ease);
      box-shadow: none;
    }
    select:focus, input:focus, textarea:focus { border-color: var(--focus); box-shadow: 0 0 0 1px var(--focus); }

    .panel {
      border: 1px solid var(--border); border-radius: 8px; padding: 12px; background: var(--panel-bg);
      box-shadow: none;
    }

    .widget {
      position: relative; border-radius: 8px; overflow: clip; background: var(--panel-bg);
      transition: none;
    }
    .widget:hover { transform: none; }
    .widget.dragging { opacity: .96; transform: none; }

    .widgetHeader { display:flex; align-items:center; justify-content:space-between; gap: 8px; padding: 8px 4px; }
    .widgetTitle { font-weight: 700; letter-spacing: .2px; }

    .grid {
      display: grid; gap: 14px; grid-template-columns: repeat(12, 1fr);
    }
    .col-12 { grid-column: span 12; }
    .col-8 { grid-column: span 8; }
    .col-7 { grid-column: span 7; }
    .col-6 { grid-column: span 6; }
    .col-5 { grid-column: span 5; }
    .col-4 { grid-column: span 4; }

    @media (max-width: 1100px) {
      .col-8, .col-7, .col-6, .col-5 { grid-column: span 12; }
    }
    @media (max-width: 720px) { .grid { gap: 10px; } }

    .ghostBtn {
      background: var(--btn-bg-secondary);
      color: var(--btn-fg-secondary);
      border: 1px solid var(--border);
      box-shadow: none;
    }

    /* Hide Manual Fork where it currently sits; we relocate it into the report */
    #modelNavRow #btnSelectRegion { display: none !important; }

    /* --- Help badge for the Model Loss Distribution button --- */
    .fs-helpWrap { position: relative; display: inline-block; }
    .fs-helpMark {
      position: absolute; top: -5px; right: -25px;
      width: 16px; height: 16px; border-radius: 9999px;
      background: var(--btn-bg); color: var(--btn-fg);
      font-weight: 800; font-size: 10px; display: inline-flex; align-items: center; justify-content: center;
      box-shadow: none; z-index: 2; cursor: default;
    }
    .fs-helpMark::after {
      content: attr(data-tip); position: absolute; top: -30px; right: 0; transform: translateY(4px);
      white-space: nowrap; padding: 4px 6px; font-size: 11px; border-radius: 6px;
      background: var(--panel-bg); color: var(--fg);
      border: 1px solid var(--border); box-shadow: none; opacity: 0; pointer-events: none;
      transition: opacity .12s ease, transform .12s ease;
    }
    .fs-helpMark::before {
      content: ""; position: absolute; top: -8px; right: 6px;
      border: 6px solid transparent; border-top-color: var(--panel-bg);
      filter: drop-shadow(0 -1px 0 var(--border)); opacity: 0; transition: opacity .12s ease;
    }
    .fs-helpMark:hover::after, .fs-helpMark:hover::before { opacity: 1; transform: translateY(0); }

    .chartTitle.fs-helpWrap {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      position: relative;
    }
    .chartTitle.fs-helpWrap .fs-helpMark {
      position: relative;
      top: auto;
      right: auto;
      width: 16px;
      height: 16px;
      font-size: 10px;
      background: var(--btn-bg);
      color: var(--btn-fg);
      cursor: default;
    }
    .chartTitle.fs-helpWrap .fs-helpMark::after {
      top: -30px;
      right: auto;
      left: 0;
      transform: translateY(4px);
    }
    .chartTitle.fs-helpWrap .fs-helpMark::before {
      top: -8px;
      right: auto;
      left: 10px;
    }
    .chartTitle.fs-helpWrap .fs-helpMark:hover::after {
      transform: translateY(0);
    }
    .chartTitle.fs-helpWrap .fs-helpMark:hover::before {
      transform: translateY(0);
    }

    /* ---------- Charts ---------- */
    .chartsRow { display: block; }
    .chartsMain { display: flex; flex-direction: column; gap: 12px; }
    .chartWrap {
      position: relative;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px;
      overflow: visible;
      background: var(--panel-bg);
      min-height: 220px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    canvas { display: block; width: 100%; max-width: 100%; }
    .chartTitle { margin: 6px 2px 2px; font-weight: 700; font-size: 14px; letter-spacing: .2px; position: relative; z-index: 2; }
    /* Let the container define the height */
    .chartWrap[data-chart="loss"]     { height: 340px; }
    .chartWrap[data-chart="accuracy"] { height: 340px; }
    .chartWrap[data-chart="valloss"]  { height: 340px; }

    /* Your histogram sits in the reportRow’s chartWrap */
    .reportRow .chartWrap { height: 260px; }

    /* Let the chart canvas consume the remaining vertical space inside each wrapper */
    .chartWrap canvas {
      flex: 1;
      width: 100%;
      height: auto;
      min-height: 0;
    }
    .regionHandleLayer {
      position: absolute;
      z-index: 4;
      pointer-events: auto;
    }
    .regionHandle {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 14px;
      border-radius: 9999px;
      background: linear-gradient(180deg, var(--focus, #fff), var(--btn-bg));
      box-shadow: 0 0 0 2px var(--border);
      transform: translateX(-50%);
      cursor: ew-resize;
      pointer-events: auto;
    }
    .regionHandle::after {
      content: '';
      position: absolute;
      inset: 10px 3px;
      border-radius: 9999px;
      background: rgba(0,0,0,0.25);
    }
    .regionHandle:active {
      box-shadow: 0 0 0 3px var(--focus, #fff);
    }



    /* === NEW: Metrics dropdown and dynamic stack === */
    .chartsToolbar { display: flex; justify-content: space-between; align-items: center; margin: 2px 0 6px; gap: 8px; flex-wrap: wrap; }
    .axisToggle {
      display: inline-flex;
      gap: 4px;
      padding: 2px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: var(--panel-bg);
    }
    .axisToggle button {
      border: none;
      background: transparent;
      color: var(--muted);
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      line-height: 1;
      cursor: pointer;
      transition: background-color .15s var(--ease), color .15s var(--ease);
    }
    .axisToggle button.active,
    .axisToggle button[aria-pressed="true"] {
      background: var(--btn-bg);
      color: var(--btn-fg);
      box-shadow: var(--btn-shadow-hover);
    }
    #metricsSelect { min-width: 170px; }
    .chartsStack { display: flex; flex-direction: column; gap: 12px; }
    .chartsStack .chartWrap { flex: 0 0 auto; height: 280px; }
    .metricCanvas {
      flex: 1;
      min-height: 0;
      display: block;
    }
    .chartCloseBtn {
      position: absolute; left: 6px; top: 6px; width: 28px; height: 28px;
      border-radius: 6px; border: 1px solid var(--border);
      background: var(--panel-bg); color: var(--fg);
      line-height: 1; font-size: 16px; font-weight: 700;
      z-index: 3;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .metricWrap .chartTitle {
      padding-left: 38px;
    }
    .chartWrap[data-chart] .chartTitle {
      padding-left: 38px;
      margin-top: 0;
    }
    .chartCloseBtn:hover { transform: translateY(-1px) scale(1.04); }
    .chartCloseBtn:active { transform: translateY(0) scale(0.96); }

    /* ---------- Report ---------- */
    .reportRow { display: grid; grid-template-columns: 3fr 1fr; gap: 12px; align-items: start; margin-top: 12px; }
    .reportSide { width: 100%; min-width: 200px; display: flex; flex-direction: column; gap: 8px; }
    .pill { padding: 6px 10px; border-radius: 9999px; background: var(--badge-bg); color: var(--badge-fg); font-weight: 700; font-size: 12px; width: max-content; box-shadow: none; }
    .note { font-size: 12px; color: var(--muted); white-space: pre-wrap; margin: 0; }
    @media (max-width: 1100px) { .reportRow { grid-template-columns: 1fr; } }

    /* ---------- Export + Icon buttons ---------- */
    .exportBtn {
      position: absolute; top: 6px; right: 6px; width: 32px; height: 32px; padding: 0; border-radius: 6px;
      border: 1px solid var(--border); background: var(--panel-bg); color: var(--fg);
      display: flex; align-items: center; justify-content: center; opacity: 1;
      transition: background .15s var(--ease);
      z-index: 2;
    }
    /* Tiny export buttons */
    .exportBtn:hover:not(:disabled) {
      opacity: 1;
      transform: translateY(-1px) scale(1.04);
      box-shadow: var(--btn-shadow-hover);
    }
    .exportBtn:active:not(:disabled) {
      transform: translateY(0) scale(0.96);
    }
    .exportBtn:disabled { opacity: .45; cursor: not-allowed; }

    .exportIcon { width: 18px; height: 18px; display: block; }

    /* ---------- DAG overlay ---------- */
    .dagOverlay { position: fixed; inset: 0; display: none; background: rgba(0,0,0,0.45); z-index: 9999; }
    .dagOverlay.show { display: block; }
    .dagPanel { position: absolute; inset: 5% 4%; background: var(--panel-bg); color: var(--fg); border: 1px solid var(--border); border-radius: 8px; box-shadow: none; display: flex; flex-direction: column; overflow: hidden; }
    .dagHeader { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border-bottom: 1px solid var(--border); background: var(--panel-bg); }
    .dagCanvasWrap { flex: 1; min-height: 380px; background: var(--panel-bg) !important; }
    #dagSvg { width: 100%; height: 100%; display: block; }

    :root{
      --dag-node-blue: var(--btn-bg);
      --dag-text: var(--vscode-editor-foreground, var(--fg));
      --dag-edge: var(--vscode-editor-foreground, var(--fg));
      --dag-minW: 960; --dag-minH: 560;
    }
    #dagSvg .dagNode rect {
      fill: var(--dag-node-blue) !important;
      stroke: var(--border) !important;
      stroke-width: 1;
      rx: 6; ry: 6;
      filter: none !important;
    }
    #dagSvg .dagNode text { fill: var(--dag-text) !important; font-weight: 600; }
    #dagSvg .dagNode, #dagSvg .dagNode rect { transition: none !important; }

    #dagSvg .dagNode.selected rect {
      stroke: #fff !important;
      stroke-width: 3 !important;
      filter: none !important;
    }

    #dagSvg .dagEdge {
      fill: none;
      color: var(--dag-edge);
      stroke: currentColor !important;
      stroke-width: 2 !important;
      opacity: 0.9 !important;
      vector-effect: non-scaling-stroke;
      filter: none !important;
    }
    #dagSvg marker#arrowHead path.dagEdgeArrow {
      fill: currentColor !important; stroke: none !important; opacity: 0.95 !important; filter: none !important;
    }

    /* --------- AutoFork settings tabs --------- */
    .afTabButtons { display:flex; gap:8px; border-bottom:1px solid var(--border); margin-bottom:10px; }
    .afTabBtn {
      padding:8px 12px; border-radius:6px 6px 0 0; border:1px solid var(--border);
      border-bottom-color: transparent; background: var(--panel-bg);
      color: var(--fg); cursor:pointer;
    }
    .afTabBtn[aria-selected="true"] { background: var(--vscode-editor-background); font-weight:700; }
    .afTabPanel { padding: 8px 4px 4px; }
    .afTabPanel[hidden] { display: none !important; }

    /* ---- AutoFork form layout ---- */
    #autoForkPanel .afTabPanel .afGrid {
      --cell-min: 260px;
      grid-template-columns: repeat(auto-fit, minmax(var(--cell-min), 1fr));
      gap: 10px 12px;
    }
    #autoForkPanel .afTabPanel .afGrid label:not(:has(> input[type="checkbox"])) {
      display: grid;
      grid-template-columns: 1fr minmax(90px, 140px);
      align-items: center; gap: 6px; white-space: normal;
    }
    #autoForkPanel .afTabPanel .afGrid label:not(:has(> input[type="checkbox"])) > input,
    #autoForkPanel .afTabPanel .afGrid label:not(:has(> input[type="checkbox"])) > select,
    #autoForkPanel .afTabPanel .afGrid label:not(:has(> input[type="checkbox"])) > textarea {
      width: 100%; min-width: 0; justify-self: end;
    }
    #autoForkPanel .afTabPanel .afGrid input[type="number"] { text-align: right; }
    @media (max-width: 600px) {
      #autoForkPanel .afTabPanel .afGrid label:not(:has(> input[type="checkbox"])) { grid-template-columns: 1fr; }
    }

    /* ---------- Utility ---------- */
    .sr-only { position:absolute; width:1px; height:1px; margin:-1px; padding:0; overflow:hidden; clip:rect(0,0,0,0); border:0; }
    .afGrid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; align-items: center; }
    .afSectionTitle { margin: 8px 0 4px; font-weight: 700; font-size: 14px; }
    .afPlanBox { min-height: 120px; max-height: 280px; overflow: auto; border: 1px solid var(--border); border-radius: 6px; padding: 8px; background: var(--panel-bg); }

    .btn-refresh { display:inline-flex; align-items:center; gap:.45rem; padding:.5rem .75rem; line-height:1; }
    .icon-rotate { font-family: "Segoe UI Symbol","Apple Symbols","Noto Sans Symbols 2","DejaVu Sans",system-ui,sans-serif; font-weight: 700; font-size: 1.6em; line-height: 1; display: inline-block; }

    /* ---------- Customizer UI ---------- */
    .customBar {
      position: sticky; top: auto; z-index: auto; display: flex; gap: 8px; padding: 10px; margin-bottom: 12px;
      border: 1px dashed var(--border); border-radius: 8px; background: var(--panel-bg); align-items: center;
    }
    .customList { display:flex; flex-wrap:wrap; gap: 8px; }
    .customList label { background: var(--panel-bg); border: 1px solid var(--border); padding: 6px 8px; border-radius: 9999px; }
    .dragHint { margin-left:auto; color: var(--muted); font-size: 12px; }

    /* ---------- Log ---------- */
    #log {
      width:100%; height:180px; resize:vertical;
      border:1px solid var(--border); border-radius:6px; padding:8px;
      background: var(--vscode-editor-background); color: var(--vscode-editor-foreground, var(--fg));
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      line-height:1.3; white-space:pre; overflow:auto;
    }

    /* ====== AutoFork ON/OFF toggles: persistent white ring ====== */
    .afToggleBtn { transition: transform 120ms ease; }
    .afToggleBtn.is-active{
      transform: scale(1.03);
      outline: 2px solid var(--focus);
      outline-offset: 2px;
    }
    .afToggleBtn.is-active:hover,
    .afToggleBtn.is-active:active,
    .afToggleBtn.is-active:focus-visible{
      transform: scale(1.04);
      outline-width: 3px;
    }
    .afToggleBtn.is-inactive { transform: scale(0.97); opacity: 0.95; }

    /* Hide selection highlight inside the DAG only (Chromium/Blink) */
    #dagSvg ::selection { background: transparent; color: inherit; }
    /* For completeness, also catch content in foreignObject */
    #dagSvg foreignObject ::selection { background: transparent; color: inherit; }

    #flyLogo {
      forced-color-adjust: none;     /* <- key */
      background: transparent;       /* belt-and-braces */
      display: block;
    }


    /* ------- Health Monitor (scoped by class prefix hm-) ------- */
    .hmBar > button { white-space: nowrap; }

    .hmDock{
      display: flex; gap: 10px;
      overflow-x: auto; overflow-y: hidden;
      padding: 4px 2px 8px;
      scroll-snap-type: x proximity;
      scrollbar-width: thin;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--panel-bg);
      min-height: 180px;
    }

    .hmCard{
      flex: 0 0 auto;
      min-width: clamp(280px, 38vw, 520px);
      max-width: 620px;
      scroll-snap-align: start;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--panel-bg);
      box-shadow: none;
      display: flex; flex-direction: column;
      overflow: hidden;
    }

    .hmCardHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding: 8px 10px; border-bottom: 1px solid var(--border);
      background: var(--panel-bg);
    }
    .hmTitle{ font-weight: 700; letter-spacing: .2px; }
    .hmClose{ width: 28px; height: 28px; line-height: 1; font-size: 18px; }

    .hmBody{
      padding: 10px;
      min-height: 140px;
      color: var(--muted);
    }

    /* subtle focus/peek when brought into view */
    .hmCard.is-peek{ outline: 2px solid var(--focus); outline-offset: -2px; }
  </style>

</head>
<body>
  <!-- ===== Header ===== -->
  <header class="flyHeader" role="banner">
    <div class="flyHeaderInner">
      
      <img class="flyLogo" src="__FLY__" alt="Fly logo" width="48" height="48" />
      <div>
        <div class="brandTitle">On the Fly</div>
        <div class="sr-only" aria-live="polite">VS Code–native dashboard for model forking and training</div>
      </div>
    </div>
  </header>

  <main class="rootWrap" role="main">

    <!-- ===== Customizer bar ===== -->
    <section class="customBar" id="customBar" aria-label="Customize dashboard layout">
      <div class="customList" id="customList" aria-live="polite">
        <label><input type="checkbox" data-widget="w-top" checked> Workspace</label>
        <!-- <label><input type="checkbox" data-widget="w-autofork" checked> AutoFork</label> -->
        <label><input type="checkbox" data-widget="w-health" checked> Health Monitoring</label>
        <label><input type="checkbox" data-widget="w-runs" checked> Models & Controls</label>
        <label><input type="checkbox" data-widget="w-charts" checked> Training Metrics</label>
        <label><input type="checkbox" data-widget="w-report" checked> Loss Distribution by Sample</label>
        <label><input type="checkbox" data-widget="w-log" checked> Logs</label>
      </div>
    </section>

    <!-- ===== Grid layout ===== -->
    <section id="flyGrid" class="grid" aria-label="Dashboard widgets">

      <!-- === Widget: Top Controls === -->
      <div class="widget col-12" data-widget-id="w-top">
        <div class="panel">
          <div class="widgetHeader"><div class="widgetTitle">Workspace</div></div>

          <div class="row" style="margin-bottom:8px">
            <button id="btnChoose">Choose Python Script</button>
            <span id="scriptName" style="font-weight:700"></span>
          </div>
          <div class="row">
            <label>Python:</label>
            <input id="pyPath" placeholder="python" />
            <button id="btnSetPy">Save Python Path</button>
            <button id="btnAutoSave">Export Session…</button>
            <button id="btnLoad">Load Session…</button>
          </div>
        </div>
      </div>

      <!-- === Widget: AutoFork === -->
      <!-- (kept collapsed in markup) -->

      <!-- === Widget: Runs & Controls === -->
      <div class="widget col-12" data-widget-id="w-runs">
        <div class="panel">
          <div class="widgetHeader"><div class="widgetTitle">Models & Controls</div></div>

          <div class="row" style="margin-bottom:8px">
            <div class="modelArrows" style="display:flex; gap:8px;">
              <button id="btnPrevModel" class="iconBtn" title="Previous model">
                <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M15 19l-7-7 7-7" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </button>
              <button id="btnNextModel" class="iconBtn" title="Next model">
                <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M9 5l7 7-7 7" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </button>
            </div>
            <select id="runSel"></select>
            <button id="btnOpenDag" title="View lineage DAG">Open Model Graph</button>
            <button id="btnRefreshRuns" class="btn-refresh" type="button"><span class="icon-rotate" aria-hidden="true">↻</span></button>
          </div>

          <div class="row" id="runControlsRow" style="margin-bottom:8px">
            <button id="btnResume" class="icon-btn" aria-label="Play" title="Play">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
            </button>
            <button id="btnPause" class="icon-btn" aria-label="Pause" title="Pause">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 5h4v14H6zm8 0h4v14h-4z"/></svg>
            </button>
            <button id="btnTestNow" title="Test Model">Test Model</button>
            <button id="btnGenerateReport" title="Compute per-sample losses">Show Model Loss Distribution</button>
            <button id="btnSelectRegion" title="Select a region on the per-sample loss distribution">Select Sample Region</button>
            <span id="modelLabel" style="font-weight:700"></span>
          </div>

          <div class="card" id="subsetExportCard">
            <div class="card-body" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <label for="exportSubsetFmt">Format</label>
              <select id="exportSubsetFmt">
                <option value="parquet" selected>.parquet</option>
                <option value="csv">.csv</option>
                <option value="feather">.feather</option>
              </select>
              <button id="btnExportSubset">Export subset for selected run</button>
            </div>
          </div>
        </div>
      </div>

      <!-- === Widget: Charts === -->
      <div class="widget col-12" data-widget-id="w-charts">
        <div class="panel">
          <div class="widgetHeader"><div class="widgetTitle">Training Metrics</div></div>

          <div class="chartsRow">
            <div class="chartsMain">

              <!-- NEW: Metrics dropdown (top-right, above loss chart) -->
              <div class="chartsToolbar">
                <label for="metricsSelect" class="sr-only">Toggle training metrics</label>
                <select id="metricsSelect" aria-label="Metrics toggle" title="-- Metrics --">
                  <option value="" selected disabled>-- Metrics --</option>
                  <option value="show_all">Show All</option>
                  <option value="loss">Training Loss</option>
                  <option value="valloss">Validation Loss</option>
                  <option value="accuracy">Accuracy</option>
                  <option value="lr">Learning Rate</option>
                  <option value="grad_norm">Gradient Norm</option>
                  <option value="weight_norm">Weight Norm</option>
                  <option value="activation_zero_frac">Activation Sparsity</option>
                  <option value="throughput">Throughput</option>
                  <option value="mem_vram">Memory</option>
                  <option value="gpu_util">GPU Util</option>
                </select>
                <div class="axisToggle" role="group" aria-label="Axis mode">
                  <button id="axisModeStep" class="axisToggleBtn" type="button" data-axis-mode="step" aria-pressed="true">Steps</button>
                  <button id="axisModeEpoch" class="axisToggleBtn" type="button" data-axis-mode="epoch" aria-pressed="false">Epochs</button>
                </div>
              </div>

              <!-- Loss chart (always visible) -->
              <div class="chartWrap" data-chart="loss">
                <button class="chartCloseBtn" data-close-chart="loss" title="Close" aria-label="Close loss chart">✕</button>
                <div class="chartTitle">Training Loss</div>
                <button id="exportLossBtn" class="exportBtn" title="Export PNG" aria-label="Export loss chart">
                  <svg class="exportIcon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M12 3v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M8 9l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M4 21h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M6 21v-2M18 21v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </button>
                <canvas id="lossChart"></canvas>
              </div>

              <!-- Accuracy chart (default secondary metric) -->
              <div class="chartWrap" data-chart="accuracy">
                <button class="chartCloseBtn" data-close-chart="accuracy" title="Close" aria-label="Close accuracy chart">✕</button>
                <div class="chartTitle">Accuracy</div>
                <button id="exportAccuracyBtn" class="exportBtn" title="Export PNG" aria-label="Export accuracy chart">
                  <svg class="exportIcon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M12 3v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M8 9l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M4 21h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M6 21v-2M18 21v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </button>
                <canvas id="accuracyChart"></canvas>
              </div>

              <!-- Validation chart (hidden until toggled) -->
              <div class="chartWrap" data-chart="valloss" style="display:none">
                <button class="chartCloseBtn" data-close-chart="valloss" title="Close" aria-label="Close validation loss chart">✕</button>
                <div class="chartTitle">Validation Loss</div>
                <button id="exportValLossBtn" class="exportBtn" title="Export PNG" aria-label="Export Val chart">
                  <svg class="exportIcon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M12 3v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M8 9l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M4 21h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M6 21v-2M18 21v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </button>
                <canvas id="valLossChart"></canvas>
              </div>
              
              <!-- NEW: Dynamic metrics stack (charts appear here, under loss) -->
              <div id="metricsStack" class="chartsStack" aria-live="polite"></div>


              <!-- Report heading -->
              <h3 class="chartTitle">Loss Distribution by Sample</h3>

              <!-- Histogram + meta -->
              <div class="reportRow">
                <div class="chartWrap">
                  <button id="exportLossDistBtn" class="exportBtn" title="Export PNG" aria-label="Export histogram">
                    <svg class="exportIcon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                      <path d="M12 3v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      <path d="M8 9l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M4 21h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      <path d="M6 21v-2M18 21v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                  </button>
                  <canvas id="lossDistChart"></canvas>
                </div>
                <aside class="reportSide">
                  <div id="reportMeta" class="pill">—</div>
                  <pre id="reportNote" class="note"></pre>
                </aside>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="widget col-12" data-widget-id="w-health">
        <div class="panel" id="healthMonitorPanel">
          <div class="widgetHeader">
            <div class="widgetTitle">Health Monitoring</div>
          </div>

          <!-- Controls -->
          <div class="row hmBar" style="margin-bottom:8px">
            <button id="btnActivationsHealth" title="Inspect Activation Health">Activation Health</button>
            <button id="btnDeterminismHealth" title="Inspect Determinism Health">Determinism Health</button>
            <button id="btnNumericsHealth" title="Inspect Numerics Health">Numerics Health</button>
            <button id="btnDistHealth" title="Inspect Distribution Health">Dist Health</button>
            <button id="btnThroughputHealth" title="Inspect Throughput Health">Throughput Health</button>
          </div>

          <!-- Sliding dock -->
          <div class="hmDock" role="region" aria-label="Health panels dock"></div>
        </div>
      </div>

      <!-- === Widget: Notes === -->
      <div class="widget col-12" data-widget-id="w-report">
        <!-- (intentionally blank; content sits above in reportRow) -->
      </div>

      <!-- === Widget: Log === -->
      <div class="widget col-12" data-widget-id="w-log">
        <div class="panel">
          <div class="widgetHeader"><div class="widgetTitle">Log</div></div>
          <textarea id="log" readonly></textarea>
        </div>
      </div>

    </section>
  </main>

  <!-- ========== DAG Overlay Markup (IDs preserved) ========== -->
  <div id="dagOverlay" class="dagOverlay" aria-hidden="true">
    <div class="dagPanel" role="dialog" aria-modal="true" aria-labelledby="dagTitle">
      <div class="dagHeader">
        <strong id="dagTitle">Model Lineage</strong>
        <div style="display:flex;gap:8px;align-items:center">
          <label style="display:flex;gap:6px;align-items:center">
            Strategy:
            <select id="dagStrategy">
              <option value="swa">Stochastic Weighted Average</option>
              <option value="fisher">Fisher Soup</option>
              <option value="adapter">Adapter Fuse</option>
            </select>
          </label>
          <button id="dagMergeBtn" disabled>Pick 2 to merge</button>
          <button id="dagClose">Close</button>
        </div>
      </div>
      <div class="dagCanvasWrap">
        <svg id="dagSvg" width="100%" height="100%" role="img" aria-label="Model lineage graph"></svg>
      </div>
    </div>
  </div>

  <!-- ===== Expose key variables & ID registry for other files ===== -->
  <script nonce="__NONCE__">
    window.OnTheFlyExports = {
      version: '1.0.0-rework',
      ids: {
        btnChoose:'btnChoose', scriptName:'scriptName', pyPath:'pyPath', btnSetPy:'btnSetPy', btnAutoSave:'btnAutoSave', btnLoad:'btnLoad', btnTestNow: 'btnTestNow',
        autoForkPanel:'autoForkPanel',
        afEnabled:'afEnabled',
        afLossPlateauPatience:'afLossPlateauPatience',
        afLossPlateauDelta:'afLossPlateauDelta',
        afPerSampleWindow:'afPerSampleWindow',
        afKmeansK:'afKmeansK',
        afDeadClusterZ:'afDeadClusterZ',
        afHighLossQuantile:'afHighLossQuantile',
        afSpikeSigma:'afSpikeSigma',
        afEmaDecay:'afEmaDecay',
        afMaxParallelChildren:'afMaxParallelChildren',
        afForkCooldownSteps:'afForkCooldownSteps',
        afGateEpochs:'afGateEpochs',
        afPslEvery:'afPslEvery',
        afPslBudget:'afPslBudget',
        afMirrorTrain:'afMirrorTrain',
        afAmpForPsl:'afAmpForPsl',
        afComputeMargins:'afComputeMargins',
        afComputeEmbeddings:'afComputeEmbeddings',
        afEmbedMaxDim:'afEmbedMaxDim',
        afPlan:'afPlan',
        afVariantIndex:'afVariantIndex',
        btnAutoForkOn:'btnAutoForkOn',
        btnAutoForkApply:'btnAutoForkApply',
        btnAutoForkExec:'btnAutoForkExec',
        afMergeOnPlateau:'afMergeOnPlateau',
        afReunifyEverySteps:'afReunifyEverySteps',
        afMinChildStepsBeforeMerge:'afMinChildStepsBeforeMerge',
        afMergeUpliftThreshold:'afMergeUpliftThreshold',
        afMergeMethodSelector: 'afMergeMethodSelector',
        afInterForkImprovement:'afInterForkImprovement',
        afForkBackpressureAlpha:'afForkBackpressureAlpha',
        runSel:'runSel', btnOpenDag:'btnOpenDag', btnRefreshRuns:'btnRefreshRuns', btnResume:'btnResume', btnPause:'btnPause',
        btnPrevModel:'btnPrevModel', btnNextModel:'btnNextModel', btnGenerateReport:'btnGenerateReport', btnSelectRegion:'btnSelectRegion', modelLabel:'modelLabel',
        btnDistHealth:'btnDistHealth', btnActivationsHealth:'btnActivationsHealth', btnNumericsHealth:'btnNumericsHealth', btnDeterminismHealth:'btnDeterminismHealth', btnThroughputHealth:'btnThroughputHealth',
        lossChart:'lossChart', valLossChart:'valLossChart', accuracyChart:'accuracyChart', lossDistChart:'lossDistChart',
        reportMeta:'reportMeta', reportNote:'reportNote',
        log:'log',
        dagOverlay:'dagOverlay', dagSvg:'dagSvg', dagStrategy:'dagStrategy', dagMergeBtn:'dagMergeBtn', dagClose:'dagClose',
        exportLossBtn:'exportLossBtn', exportValLossBtn:'exportValLossBtn', exportAccuracyBtn:'exportAccuracyBtn', exportLossDistBtn:'exportLossDistBtn',
        metricsSelect:'metricsSelect', metricsStack:'metricsStack',
        axisModeStep:'axisModeStep', axisModeEpoch:'axisModeEpoch'
      },
      cssVars: ['--bg','--fg','--muted','--panel-bg','--panel-elev','--border','--btn-bg','--btn-fg','--btn-shadow','--btn-shadow-hover','--chart-text','--chart-grid'],
      widgets: ['w-top','w-autofork','w-runs','w-charts','w-report','w-log']
      
    };
  </script>

  <!-- ===== Layout customizer (drag & drop + persistence) ===== -->
  <script nonce="__NONCE__">
    (function(){
      const grid = document.getElementById('flyGrid');
      const customBar = document.getElementById('customBar');
      const list = document.getElementById('customList');
      const LS_KEY = 'fs.layout.v1';

      function widgets(){ return Array.from(grid.querySelectorAll('.widget')); }
      function idOf(w){ return w.getAttribute('data-widget-id'); }

      function loadState(){ try { return JSON.parse(localStorage.getItem(LS_KEY)||'{}'); } catch(e){ return {}; } }
      function saveState(state){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

      function applyState(){
        const s = loadState();
        widgets().forEach(w => { const id = idOf(w); const vis = s.visibility ? s.visibility[id] : true; w.hidden = vis === false; });
        list.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          const id = cb.dataset.widget; cb.checked = (s.visibility && s.visibility[id] === false) ? false : true;
        });
      }

      function stateFromDOM(){
        const visibility = {};
        list.querySelectorAll('input[type="checkbox"]').forEach(cb => { visibility[cb.dataset.widget] = cb.checked; });
        return { visibility };
      }

      list.addEventListener('change', () => {
        const s = stateFromDOM();
        widgets().forEach(w => { const id = idOf(w); w.hidden = s.visibility[id] === false; });
        saveState(s);
      });

      function wireDnD(){ /* no-op for now */ }

      applyState();
      wireDnD();
    })();
  </script>

  <!-- ===== Script placeholders injected by host ===== -->
  <script nonce="__NONCE__" src="__CHART_JS__"></script>
  <script nonce="__NONCE__" src="__CHART_UTILS__"></script>
  <script nonce="__NONCE__" src="__CHART_PLUGINS_JS__"></script>
  <script nonce="__NONCE__" src="__CHART_CREATION_JS__"></script>
  <script nonce="__NONCE__" src="__CHART_STREAM_JS__"></script>
  <script nonce="__NONCE__" src="__LOG_BUFFER_JS__"></script>
  <script nonce="__NONCE__" src="__IPC_CONTROLS_JS__"></script>
  <script nonce="__NONCE__" src="__CHART_BOOTSTRAP_JS__"></script>
  <script nonce="__NONCE__" src="__CHART_REPORT_JS__"></script>
  <script nonce="__NONCE__" src="__REPORT_SELECTION_JS__"></script>
  <script nonce="__NONCE__" src="__DAG_LAYOUT_JS__"></script>
  <script nonce="__NONCE__" src="__DAG_RENDER_JS__"></script>
  <script nonce="__NONCE__" src="__HEALTH_MONITOR_JS__"></script>
  <!-- <script nonce="__NONCE__" src="__AUTOFORK_PANEL_JS__"></script> -->
  <script nonce="__NONCE__" src="__RUN_STATE_JS__"></script>
  <script nonce="__NONCE__" src="__DASHBOARD_JS__"></script>
</body>
</html>
